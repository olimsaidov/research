# Тизим архитектураси диаграммаси

## Умумий кўриниш
Бу диаграмма Jarima платформасининг кенг қамровли тизим архитектурасини тасвирлайди, турли компонентлар йўл ҳаракати қоидабузарликларини хабар қилиш учун масштабланадиган фуқаролик технология ечимини яратиш учун қандай ўзаро таъсир қилишини кўрсатади.

## Архитектура диаграммаси

```mermaid
graph TB
    subgraph "Фойдаланувчи қатлами"
        C[Фуқаролар<br/>Мобил/Веб]
        S[Ходимлар/Инспекторлар<br/>Веб портал]
        A[Администраторлар<br/>Админ панели]
        TP[Учинчи томон иловалари<br/>API орқали]
    end

    subgraph "API шлюзи қатлами"
        AG[API шлюзи<br/>- Аутентификация<br/>- Тезликни чеклаш<br/>- Сўров йўналиши]
        OAuth[OAuth2 сервери<br/>- Авторизация коди<br/>- Мижоз ҳисоб маълумотлари<br/>- Токен бошқаруви]
    end

    subgraph "Илова қатлами"
        subgraph "Асосий хизматлар"
            WA[Веб илова<br/>Clojure/Luminus]
            RS[Ҳисобот хизмати]
            VS[Қоидабузарлик хизмати]
            US[Фойдаланувчи хизмати]
            PS[Тўлов хизмати]
            NS[Хабарнома хизмати]
        end
        
        subgraph "Фон ишчилари"
            ET[Кодлаш тикери<br/>60 сония интервал]
            DT[Детектор тикери<br/>100 сония интервал]
            WT[Webhook тикери<br/>60 сония интервал]
            TB[Telegram боти]
        end
    end

    subgraph "Микросервислар қатлами"
        ES[Кодлаш хизмати<br/>Видео транскодлаш]
        DS[Детектор хизмати<br/>AI аниқлаш]
    end

    subgraph "Маълумотлар қатлами"
        PG[(PostgreSQL<br/>- Фойдаланувчи маълумотлари<br/>- Ҳисоботлар<br/>- Қоидабузарликлар<br/>- Транзакциялар)]
        Redis[(Redis<br/>- Сессиялар<br/>- Кеш<br/>- Вақтинчалик маълумотлар)]
        MinIO[(MinIO кластерлари<br/>- Видеолар<br/>- Тасвирлар<br/>- Ҳужжатлар)]
    end

    subgraph "Ташқи хизматлар"
        ASBT[ASBT<br/>Ҳукумат тизими]
        Kash[Kash шлюзи<br/>Телефон кредитлари]
        UzCard[UzCard<br/>Банк ўтказмалари]
        SMS[SMS провайдери]
    end

    %% Фойдаланувчи уланишлари
    C --> AG
    S --> AG
    A --> AG
    TP --> OAuth
    OAuth --> AG

    %% API шлюзидан хизматларга
    AG --> WA
    AG --> RS
    AG --> VS
    AG --> US
    AG --> PS
    AG --> NS

    %% Хизматдан маълумотлар қатламига
    WA --> PG
    WA --> Redis
    RS --> PG
    RS --> MinIO
    VS --> PG
    US --> PG
    PS --> PG
    NS --> PG

    %% Фон ишчилари
    ET --> ES
    ET --> MinIO
    DT --> DS
    DT --> MinIO
    WT --> PG
    TB --> NS

    %% Микросервислар уланишлари
    ES --> MinIO
    DS --> MinIO
    RS --> ES
    RS --> DS

    %% Ташқи хизмат уланишлари
    VS --> ASBT
    PS --> Kash
    PS --> UzCard
    NS --> SMS
    NS --> TB

    %% Маълумотлар оқими стиллаштириш
    classDef userLayer fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef apiLayer fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef appLayer fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef dataLayer fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef externalLayer fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef microLayer fill:#f1f8e9,stroke:#33691e,stroke-width:2px

    class C,S,A,TP userLayer
    class AG,OAuth apiLayer
    class WA,RS,VS,US,PS,NS,ET,DT,WT,TB appLayer
    class PG,Redis,MinIO dataLayer
    class ASBT,Kash,UzCard,SMS externalLayer
    class ES,DS microLayer
```

## Компонент тавсифи

### Фойдаланувчи қатлами
- **Фуқаролар**: Веб ёки мобил орқали қоидабузарликларни хабар қилувчи асосий фойдаланувчилар
- **Ходимлар/Инспекторлар**: Қоидабузарликларни кўриб чиқувчи ва қайта ишлайдиган ҳукумат ходимлари
- **Администраторлар**: Фойдаланувчилар ва конфигурацияни бошқарувчи тизим администраторлари
- **Учинчи томон иловалари**: OAuth2 APIлари орқали платформага кирувчи ташқи иловалар

### API шлюзи қатлами
- **API шлюзи**: Аутентификация, тезликни чеклаш ва йўналишни бошқарувчи марказий кириш нуқтаси
- **OAuth2 сервери**: Кўп грант турлари билан учинчи томон иловалари учун авторизацияни бошқаради

### Илова қатлами
#### Асосий хизматлар
- **Веб илова**: Бизнес мантиғини бошқарувчи асосий Clojure/Luminus монолити
- **Ҳисобот хизмати**: Қоидабузарлик ҳисоботларини тақдим этишдан ечимгача бошқаради
- **Қоидабузарлик хизмати**: Ҳисоботлар ичидаги алоҳида қоидабузарликларни қайта ишлайди
- **Фойдаланувчи хизмати**: Фойдаланувчи бошқаруви ва аутентификацияни бошқаради
- **Тўлов хизмати**: Мукофотлар ва тўлов қайта ишлашни бошқаради
- **Хабарнома хизмати**: SMS, электрон почта ва Telegram орқали огоҳлантиришлар юборади

#### Фон ишчилари
- **Кодлаш тикери**: Ҳар 60 сонияда видео кодлаш навбатини қайта ишлайди
- **Детектор тикери**: Ҳар 100 сонияда AI аниқлаш навбатини бошқаради
- **Webhook тикери**: OAuth мижозларига webhook хабарномаларини етказади
- **Telegram боти**: Telegram хабарлашуви ва хабарномаларини бошқаради

### Микросервислар қатлами
- **Кодлаш хизмати**: Видео транскодлаш ва стандартлаштириш учун ташқи хизмат
- **Детектор хизмати**: Қоидабузарликни аниқлаш ва рақам белгисини таниш учун AI билан ишлайдиган хизмат

### Маълумотлар қатлами
- **PostgreSQL**: Барча транзакцион маълумотлар учун асосий маълумотлар базаси
- **Redis**: Сессия сақлаш ва кешлаш қатлами
- **MinIO**: Видеолар ва тасвирлар учун тарқатилган объект сақлаш

### Ташқи хизматлар
- **ASBT**: Ҳукумат йўл ҳаракати қоидабузарлик тизими интеграцияси
- **Kash шлюзи**: Телефон кредитини тўлдириш учун тўлов провайдери
- **UzCard**: Банк карта ўтказмалари учун миллий тўлов тизими
- **SMS провайдери**: SMS хабарнома етказиб бериш

## Асосий архитектура қарорлари

1. **Гибрид архитектура**: CPU талаб қиладиган вазифалар микросервислар сифатида монолитдаги асосий бизнес мантиғи
2. **Навбатга асосланган қайта ишлаш**: Масштаблилик учун асинхрон қайта ишлаш
3. **Кўп сақлаш стратегияси**: Маълумотлар учун PostgreSQL, кеш учун Redis, объектлар учун MinIO
4. **Хизмат изоляцияси**: Circuit breaker билан ўралган ташқи хизматлар
5. **Горизонтал масштаблилик**: Осон масштаблашни таъминлайдиган ҳолатсиз дизайн

## Иш самарадорлиги хусусиятлари

- **Сўров бошқариш**: 10,000+ сўров/дақиқа қуввати
- **Видео қайта ишлаш**: Ўртача 30 сония қайта ишлаш вақти
- **Тўлов қайта ишлаш**: Кунига 100,000+ транзакция қобилияти
- **Сақлаш**: CDNлар бўйлаб кўп терабайтли видео сақлаш
- **Мавжудлик**: 99.9% ишлаш вақтига эришилди

## Хавфсизлик хусусиятлари

- **Кўп қатламли аутентификация**: Сессия, OAuth2, API калитлари, 2FA
- **Рол асосидаги кириш назорати**: Ҳар бир фойдаланувчи тури учун аниқ рухсатлар
- **Маълумотларни шифрлаш**: Тинчлик ҳолатида ва транзитда шифрлаш
- **Аудит журнали**: Барча операцияларнинг тўлиқ изи
- **API хавфсизлиги**: Тезликни чеклаш, CORS, киритиш текшируви